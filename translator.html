<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Beluma Translator (Dova Lingvo)</title>
<style>
    /* --- General Reset & Layout --- */
    body {
        font-family: 'Google Sans', Roboto, Arial, sans-serif;
        padding: 0;
        margin: 0;
        background: #f8f9fa; /* Light background */
        color: #3c4043; /* Dark gray text */
    }
    .container {
        max-width: 900px;
        margin: 40px auto;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    h1 {
        font-size: 1.8rem;
        color: #1a73e8; /* Google blue */
        margin-bottom: 20px;
        border-bottom: 1px solid #dadce0;
        padding-bottom: 10px;
    }

    /* --- Dictionary Status --- */
    #status {
        color: #1a73e8; 
        font-weight: bold;
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #dadce0;
        border-radius: 8px;
        background: #e8f0fe; /* Light blue hint background */
    }

    /* --- Translator Interface (Google Translate Look) --- */
    .translator-area {
        display: flex;
        gap: 15px;
        margin-top: 20px;
    }
    .input-pane, .output-pane {
        flex: 1;
        position: relative;
        border: 1px solid #dadce0;
        border-radius: 8px;
        padding: 15px;
        padding-bottom: 50px; /* Added space for new controls */
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        min-height: 200px; /* Ensure visual height */
        display: flex;
        flex-direction: column;
    }
    .language-header {
        font-weight: 500;
        color: #5f6368;
        padding-bottom: 10px;
        margin-bottom: 10px;
        border-bottom: 1px solid #dadce0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* --- Text Areas --- */
    #tekstoInput, #output {
        flex-grow: 1; /* Take up remaining height */
        border: none;
        resize: none;
        padding: 0;
        margin: 0;
        font-size: 1.1rem;
        line-height: 1.5;
        width: 100%;
        box-sizing: border-box;
        background: transparent;
        color: #202124;
    }
    #tekstoInput:focus {
        outline: none;
    }
    
    /* Output area styling (text-only, non-editable) */
    #output {
        white-space: pre-wrap; /* Ensure all spaces are preserved */
        font-weight: normal; 
    }
    .output-pane {
        background: #f1f3f4; /* Subtle gray background for output */
    }

    /* --- Controls (Swap Button) --- */
    .controls {
        text-align: center;
        margin: 10px 0;
    }
    #swapBtn {
        background: white;
        border: 1px solid #dadce0;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
        color: #1a73e8;
        cursor: pointer;
        transition: background 0.3s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    #swapBtn:hover {
        background: #f8f9fa;
    }
    #swapBtn:disabled {
        color: #bdc1c6;
        cursor: not-allowed;
    }

    /* --- Interaction Buttons (Copy & TTS) --- */
    .interaction-controls {
        position: absolute;
        bottom: 10px;
        right: 10px;
        display: flex;
        gap: 8px;
    }
    .interaction-btn {
        background: none;
        border: none;
        color: #5f6368;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: background-color 0.15s, color 0.15s;
        font-size: 1.1rem;
        line-height: 1;
    }
    .interaction-btn:hover {
        background-color: #e8f0fe;
        color: #1a73e8;
    }
    .interaction-btn:disabled {
        color: #bdc1c6;
        cursor: not-allowed;
    }
</style>
</head>
<body>

<div class="container">
    <h1>Beluma Translator (Auto-Loaded)</h1>
    <p style="font-size:0.85rem; color:#5f6368;">
        (The Beluma language uses systematic morphology, prefixes like $ré$- (again) and suffixes like $-s$ (plural). Tense is defined by particles like $ha$ (habitual) and $ta$ (past).)
    </p>

    <div id="status">Loading dictionary from URL...</div>

    <div class="translator-area">
        <div class="input-pane">
            <div id="sourceLanguage" class="language-header">English</div>
            <textarea id="tekstoInput" placeholder="Type or paste text here (e.g., Hello there!)" disabled></textarea>
            <div class="interaction-controls">
                <button id="copyInputBtn" class="interaction-btn" title="Copy Text" disabled>&#x2398;</button> 
                <button id="speakInputBtn" class="interaction-btn" title="Listen" disabled>&#x1F50A;</button> 
            </div>
        </div>

        <div class="controls">
            <button id="swapBtn" title="Swap Languages" disabled>&#8646;</button>
        </div>

        <div class="output-pane">
            <div id="targetLanguage" class="language-header">Beluma</div>
            <div id="output"></div>
            <div class="interaction-controls">
                <button id="copyOutputBtn" class="interaction-btn" title="Copy Text" disabled>&#x2398;</button> 
                <button id="speakOutputBtn" class="interaction-btn" title="Listen" disabled>&#x1F50A;</button> 
            </div>
        </div>
    </div>
</div>

<script>
// --- Configuration ---
const DICTIONARY_URL = 'https://xpdevs.github.io/Beluma/h.txt';

// Dictionaries and State
let anglaAlBeluma = {};
let belumaAlAngla = {};
let isEnglishToBeluma = true; // Current direction state
const synth = window.speechSynthesis; // TTS API

// Elements
const statusElement = document.getElementById('status');
const tekstoInput = document.getElementById('tekstoInput');
const output = document.getElementById('output');
const swapBtn = document.getElementById('swapBtn');
const sourceLanguageDisplay = document.getElementById('sourceLanguage');
const targetLanguageDisplay = document.getElementById('targetLanguage');

// Interaction buttons
const copyInputBtn = document.getElementById('copyInputBtn');
const speakInputBtn = document.getElementById('speakInputBtn');
const copyOutputBtn = document.getElementById('copyOutputBtn');
const speakOutputBtn = document.getElementById('speakOutputBtn');

// --- Core Translation Functions (Kept the same) ---

function parseLingvoData(lingvoData) {
    const linioj = lingvoData.split('\n');
    anglaAlBeluma = {};
    belumaAlAngla = {};

    for (let linio of linioj) {
        linio = linio.trim();
        if (!linio || linio.startsWith('---')) continue;
        const partoj = linio.split('=');
        if (partoj.length === 2) {
            const beluma = partoj[0].trim();
            let angla = partoj[1].trim();
            angla = angla.replace(/\(.*?\)/g, '').trim(); 
            const opcioj = angla.split('/').map(o => o.trim().toLowerCase());
            
            for (let o of opcioj) {
                anglaAlBeluma[o] = beluma;
            }
            
            if (opcioj.length > 0) {
                belumaAlAngla[beluma] = opcioj[0]; 
            }
        }
    }
}

/**
 * Translates a single word/token, handling punctuation and case, or returns the token untouched if it's whitespace/punctuation.
 */
function tradukToken(token, dictionario) {
    // 1. Check if the token is pure whitespace (space, tab, newline)
    if (token.match(/^\s+$/)) {
        return token; // Return whitespace token untouched
    }

    // 2. Check if the token is just punctuation or empty after trimming
    token = token.trim();
    if (!token || !token.match(/[a-zA-Z0-9]/)) {
        return token;
    }

    // 3. Process as a word
    let antaŭPunkto = token.match(/^([^a-zA-Z0-9]*)/)?.[0] || '';
    let finPunkto = token.match(/([^a-zA-Z0-9]*)$/)?.[0] || '';
    
    let kernaVorto = token.substring(antaŭPunkto.length, token.length - finPunkto.length);
    
    const ĉuKapitala = kernaVorto.length > 0 && kernaVorto[0] === kernaVorto[0].toUpperCase();

    const malgranda = kernaVorto.toLowerCase();
    
    let tradukitaKerno = dictionario[malgranda] || kernaVorto;
    
    if (ĉuKapitala && tradukitaKerno.length > 0) {
        tradukitaKerno = tradukitaKerno.charAt(0).toUpperCase() + tradukitaKerno.slice(1);
    }
    
    return antaŭPunkto + tradukitaKerno + finPunkto;
}

/**
 * Translates an entire input string word-by-word, preserving all whitespace and punctuation.
 */
function tradukFrazo(frazo) {
    const dictionario = isEnglishToBeluma ? anglaAlBeluma : belumaAlAngla;
    
    // Use a regex that captures WORDS, PUNCTUATION BLOCKS, AND WHITESPACE
    const tokens = frazo.match(/(\s+)|([a-zA-Z0-9]+)|([^\s]+)/g) || [frazo];

    const tradukitaj = tokens.map(tradukTokeni => tradukToken(tradukTokeni, dictionario));
    
    // Join the processed tokens without adding any extra spaces.
    return tradukitaj.join('');
}

// --- Interaction Functions (Copy & TTS - Kept the same) ---

function copyText(element) {
    let text = element.tagName === 'TEXTAREA' ? element.value : element.textContent;
    if (!text) {
        return;
    }
    // Using execCommand as a robust fallback for clipboard operations in iframe environments
    try {
        const tempArea = document.createElement('textarea');
        tempArea.value = text;
        document.body.appendChild(tempArea);
        tempArea.select();
        document.execCommand('copy');
        document.body.removeChild(tempArea);
        console.log('Text copied to clipboard!');
    } catch (err) {
        console.error('Copying failed:', err);
    }
}

function speakText(text, lang) {
    if (!synth || !text) return;
    
    if (synth.speaking) {
        synth.cancel(); 
    }

    const utterance = new SpeechSynthesisUtterance(text);
    // Use 'en-US' as a neutral voice for the constructed language
    utterance.lang = lang === 'English' ? 'en-US' : 'en-US'; 
    
    synth.speak(utterance);
}

// --- UI Logic and Event Handlers ---

function updateInteractionButtonState() {
    const hasInput = tekstoInput.value.trim().length > 0;
    const hasOutput = output.textContent.trim().length > 0;
    
    // Input Box Controls
    copyInputBtn.disabled = !hasInput;
    speakInputBtn.disabled = !hasInput;

    // Output Box Controls
    copyOutputBtn.disabled = !hasOutput;
    speakOutputBtn.disabled = !hasOutput;
}

function enableTranslator() {
    statusElement.textContent = 'Dictionary loaded successfully! Start typing to translate.';
    statusElement.style.color = 'green';
    swapBtn.disabled = false;
    tekstoInput.disabled = false; // Enable input
    handleTranslation(); 
    updateInteractionButtonState();
}

function disableTranslator(message) {
    statusElement.textContent = message;
    statusElement.style.color = 'red';
    swapBtn.disabled = true;
    tekstoInput.disabled = true; // Disable input on error
    output.textContent = '';
    tekstoInput.value = '';
    updateInteractionButtonState(); 
}

function updateLanguageDisplays() {
    if (isEnglishToBeluma) {
        sourceLanguageDisplay.textContent = 'English';
        targetLanguageDisplay.textContent = 'Beluma';
        tekstoInput.placeholder = 'Type English text here (e.g., Hello there!)...';
    } else {
        sourceLanguageDisplay.textContent = 'Beluma';
        targetLanguageDisplay.textContent = 'English';
        tekstoInput.placeholder = 'Type Beluma text here (e.g., Sala théra!)...';
    }
}

function handleTranslation() {
    const eniro = tekstoInput.value;
    if (eniro === '') { 
        output.textContent = '';
    } else {
        output.textContent = tradukFrazo(eniro);
    }
    updateInteractionButtonState(); 
}

// --- NEW: Dictionary Loading Function ---

async function loadDictionary() {
    try {
        const response = await fetch(DICTIONARY_URL);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const lingvoData = await response.text();
        parseLingvoData(lingvoData);
        updateLanguageDisplays();
        enableTranslator();
    } catch (error) {
        disableTranslator(`Error loading dictionary from URL. Please check the network and URL (${DICTIONARY_URL}). Error: ${error.message}`);
        console.error('Dictionary load error:', error);
    }
}

// --- Event Listeners ---

// 1. Input Change (Automatic Translation as you type)
tekstoInput.addEventListener('input', handleTranslation);

// 2. Swap Languages Button
swapBtn.addEventListener('click', function() {
    isEnglishToBeluma = !isEnglishToBeluma; // Toggle state
    
    // Swap content of input and output fields
    const currentInput = tekstoInput.value;
    const currentOutput = output.textContent;
    tekstoInput.value = currentOutput;
    
    // Update language headers and placeholder
    updateLanguageDisplays();
    
    // Immediately translate the swapped content
    handleTranslation();
});

// 3. Interaction Button Event Listeners
copyInputBtn.addEventListener('click', () => copyText(tekstoInput));
speakInputBtn.addEventListener('click', () => speakText(tekstoInput.value, sourceLanguageDisplay.textContent));
copyOutputBtn.addEventListener('click', () => copyText(output));
speakOutputBtn.addEventListener('click', () => speakText(output.textContent, targetLanguageDisplay.textContent));

// 4. Initialization - Load dictionary on startup
window.onload = function() {
    updateLanguageDisplays();
    updateInteractionButtonState();
    loadDictionary(); 
};
</script>
</body>
</html>
